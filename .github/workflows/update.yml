name: Collect & Filter V2Ray Configs

on:
  schedule:
    # Every 3 hours (same cadence as before)
    - cron: "0 */3 * * *"
  workflow_dispatch:       # allow manual trigger from GitHub UI

permissions:
  contents: write          # needed to push output/ changes back to repo

jobs:
  collect-and-filter:
    runs-on: ubuntu-latest
    timeout-minutes: 60    # safety cap â€” thorough scan can take ~45 min

    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ 2. Setup Python â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # â”€â”€ 3. Install dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        run: pip install requests

      # â”€â”€ 4. Collect configs from Telegram channels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Collect configs
        run: python collector.py
        timeout-minutes: 10

      # â”€â”€ 5. Show collected count â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Show collected config count
        run: |
          if [ -f output/sub.txt ]; then
            COUNT=$(grep -c "://" output/sub.txt 2>/dev/null || echo 0)
            echo "âœ… Collected $COUNT configs"
          else
            echo "âš ï¸  output/sub.txt not found after collection"
            exit 1
          fi

      # â”€â”€ 6. Filter & rank by latency + speed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Filter and rank configs
        run: |
          python filter.py \
            --mode quick \
            --workers 50 \
            --speed-workers 8 \
            --timeout 5 \
            --speed-timeout 30
        timeout-minutes: 45

      # â”€â”€ 7. Show filtered count â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Show filtered config count
        run: |
          if [ -f output/sub.txt ]; then
            COUNT=$(grep -c "://" output/sub.txt 2>/dev/null || echo 0)
            echo "âœ… Filtered output: $COUNT alive configs"
            echo "---"
            echo "Stats:"
            cat output/stats.json 2>/dev/null || echo "(no stats file)"
          fi

      # â”€â”€ 8. Commit & push results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit and push results
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output/sub.txt output/base64.txt output/stats.json
          # Only commit if something actually changed
          git diff --staged --quiet && echo "No changes to commit" || \
            git commit -m "ðŸ”„ Auto-update: collected + filtered configs [$(date -u '+%Y-%m-%d %H:%M UTC')]"
          git push
